"use strict";const e=require("../common/vendor.js"),t=require("../config/config.js"),o=require("../utils/api.js"),s={name:"FloatingButtons",data:()=>({scrollTop:0,showDrawer:!1,userInfo:null,avatarUrl:"https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0",nickname:"",tempOpenid:"",tempToken:"",isLoggingIn:!1,loginStatus:"",isLiking:!1,likeAnimation:!1}),mounted(){this.checkUserInfo()},methods:{async showUserDrawer(){this.showDrawer=!0,this.$emit("drawerShow"),this.userInfo||await this.startWechatLogin()},hideUserDrawer(){this.showDrawer=!1,this.$emit("drawerHide")},checkUserInfo(){try{const t=e.index.getStorageSync("userInfo");t&&(this.userInfo=t)}catch(t){console.error("获取用户信息失败:",t)}},async startWechatLogin(){this.isLoggingIn=!0,this.loginStatus="正在获取登录信息...";try{this.loginStatus="正在获取微信授权...";const t=await e.index.login();if(!t.code)throw new Error("获取微信登录code失败");this.loginStatus="正在验证用户信息...";const s=await o.ApiService.wechat.login(t.code);console.log("后端返回:",s),s.is_new_user?(this.tempOpenid=s.openid,this.tempToken=s.token,this.isLoggingIn=!1,this.loginStatus=""):(this.loginStatus="登录成功！",this.userInfo=s.user_info,this.userInfo.token=s.token,e.index.setStorageSync("userInfo",this.userInfo),e.index.setStorageSync("wechat_token",s.token),setTimeout((()=>{this.isLoggingIn=!1,this.loginStatus="",e.index.showToast({title:"登录成功",icon:"success"})}),1e3))}catch(t){console.error("微信登录失败:",t),this.isLoggingIn=!1,this.loginStatus="",e.index.showToast({title:"登录失败",icon:"error"}),this.hideUserDrawer()}},async onChooseAvatar(t){const{avatarUrl:o}=t.detail;console.log("选择头像成功:",t),e.index.showLoading({title:"正在上传头像..."});try{const t=await this.uploadAvatarToServer(o);if(!t||!t.url)throw new Error("上传失败");this.avatarUrl=this.getStaticUrl(t.url),e.index.hideLoading(),e.index.showToast({title:"头像上传成功",icon:"success"})}catch(s){console.error("头像上传失败:",s),e.index.hideLoading(),e.index.showToast({title:"头像上传失败",icon:"error"}),this.avatarUrl=o}},onNicknameInput(e){this.nickname=e.detail.value,console.log("昵称输入:",this.nickname)},uploadAvatarToServer:async o=>new Promise(((s,i)=>{e.index.uploadFile({url:t.CONFIG_UTILS.getApiUrl("/user/uploadAvatar"),filePath:o,name:"avatar",success:e=>{try{const t=JSON.parse(e.data);200===t.code?s(t.data):i(new Error(t.message||"上传失败"))}catch(t){i(new Error("响应解析失败"))}},fail:e=>{console.error("上传失败:",e),i(e)}})})),async saveUserInfo(){if(this.avatarUrl&&this.nickname)if(this.tempOpenid)try{const t={openid:this.tempOpenid,nickName:this.nickname,avatarUrl:this.avatarUrl,gender:0,country:"",province:"",city:"",language:"zh_CN"},s=await o.ApiService.wechat.completeUserInfo(t);console.log(),this.userInfo=s.user_info,this.userInfo.token=s.token,e.index.setStorageSync("userInfo",this.userInfo),e.index.setStorageSync("wechat_token",s.token),this.tempOpenid="",this.tempToken="",e.index.showToast({title:"注册成功",icon:"success"})}catch(t){console.error("保存用户信息失败:",t),e.index.showToast({title:"保存失败",icon:"error"})}else e.index.showToast({title:"登录信息已过期，请重新登录",icon:"none"});else e.index.showToast({title:"请选择头像并输入昵称",icon:"none"})},async saveUserInfoToServer(){if(this.userInfo)try{const t=await o.ApiService.user.saveUserInfo(this.userInfo);console.log("用户信息保存成功:",t),t&&t.user_key&&(this.userInfo.userKey=t.user_key,e.index.setStorageSync("userInfo",this.userInfo))}catch(t){console.error("保存用户信息失败:",t)}},logout(){e.index.showModal({title:"确认退出",content:"确定要退出登录吗？",success:t=>{t.confirm&&(this.userInfo=null,this.avatarUrl="https://mmbiz.qpic.cn/mmbiz/icTdbqWNOwNRna42FI242Lcia07jQodd2FJGIYQfG0LAJGFxM4FbnQP6yfMxBgJ0F3YRqJCJ1aPAK2dQagdusBZg/0",this.nickname="",this.tempOpenid="",this.tempToken="",e.index.removeStorageSync("userInfo"),e.index.removeStorageSync("wechat_token"),this.showDrawer=!1,e.index.showToast({title:"已退出",icon:"success"}))}})},scrollToTop(){e.index.pageScrollTo({scrollTop:0,duration:300}),this.$emit("scrollToTop")},getStaticUrl:e=>t.CONFIG_UTILS.getStaticUrl(e),async like(){if(!this.isLiking){this.isLiking=!0,this.likeAnimation=!0;try{if(this.userInfo&&this.userInfo.id){e.index.getStorageSync("wechat_token")&&(this.userInfo.likeCount=(this.userInfo.likeCount||0)+1,e.index.setStorageSync("userInfo",this.userInfo))}this.$emit("like"),setTimeout((()=>{e.index.showToast({title:"点赞成功",icon:"success"})}),300)}catch(t){console.error("点赞失败:",t),e.index.showToast({title:"点赞失败",icon:"error"})}finally{setTimeout((()=>{this.likeAnimation=!1,this.isLiking=!1}),1e3)}}}}};const i=e._export_sfc(s,[["render",function(t,o,s,i,n,r){return e.e({a:r.getStaticUrl("/static/svg/classroom.svg"),b:e.o(((...e)=>r.showUserDrawer&&r.showUserDrawer(...e))),c:r.getStaticUrl("/static/svg/thumbs-up.svg"),d:e.o(((...e)=>r.like&&r.like(...e))),e:r.getStaticUrl("/static/svg/top.svg"),f:e.o(((...e)=>r.scrollToTop&&r.scrollToTop(...e))),g:n.showDrawer},n.showDrawer?{h:e.o(((...e)=>r.hideUserDrawer&&r.hideUserDrawer(...e)))}:{},{i:e.o(((...e)=>r.hideUserDrawer&&r.hideUserDrawer(...e))),j:n.isLoggingIn},n.isLoggingIn?{k:e.t(n.loginStatus)}:n.userInfo?{t:n.userInfo.avatar,v:e.t(n.userInfo.nickName),w:e.t(n.userInfo.visitCount||0),x:e.t(n.userInfo.likeCount||0),y:e.o(((...e)=>r.logout&&r.logout(...e)))}:{m:n.avatarUrl,n:e.o(((...e)=>r.onChooseAvatar&&r.onChooseAvatar(...e))),o:e.o(((...e)=>r.onNicknameInput&&r.onNicknameInput(...e))),p:n.nickname,q:e.o((e=>n.nickname=e.detail.value)),r:e.o(((...e)=>r.saveUserInfo&&r.saveUserInfo(...e))),s:!n.avatarUrl||!n.nickname},{l:!n.userInfo,z:n.showDrawer?1:""})}],["__scopeId","data-v-b60f5de7"]]);wx.createComponent(i);
