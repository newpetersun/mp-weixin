"use strict";const e=require("../../common/vendor.js"),t=require("../../config/config.js"),i=require("../../utils/api.js"),r={data:()=>({loading:!1,error:null,projects:[],selectedProject:null,selectedProjectIndex:0,requirements:[],showRequirementModal:!1,showDetailModal:!1,showDeleteModal:!1,showAssigneeModal:!1,isEditing:!1,editingRequirementId:null,deletingRequirementId:null,currentRequirement:null,isSaving:!1,templates:[],assigneeOptions:[],currentFilter:"all",requirementForm:{title:"",description:"",status:"pending",priority:"medium",estimated_hours:"",assignee:"",assignee_id:null,template_id:null},statusOptions:["未开始","进行中","已完成"],statusIndex:0,statusMap:{0:"pending",1:"progress",2:"completed"},priorityOptions:["低","中","高"],priorityIndex:1,priorityMap:{0:"low",1:"medium",2:"high"},templateOptions:[],templateIndex:-1}),computed:{canSave(){return this.requirementForm.title.trim()&&this.requirementForm.description.trim()},filteredRequirements(){return"all"===this.currentFilter?this.requirements:this.requirements.filter((e=>e.status===this.currentFilter))}},methods:{getStaticUrl:e=>t.CONFIG_UTILS.getStaticUrl(e),goBack(){e.index.navigateBack()},async loadProgressData(){this.loading=!0,this.error=null;try{const[e,t,r]=await Promise.all([i.ApiService.project.getList({status:0}),i.ApiService.progress.getTemplates(),i.ApiService.progress.getEngineers()]);this.projects=e.list,this.templates=t,this.templateOptions=t,this.assigneeOptions=r,this.projects.length>0&&(this.selectedProject=this.projects[0],this.selectedProjectIndex=0,await this.loadRequirements())}catch(e){this.error=e.message||"数据加载失败",i.ApiErrorHandler.handle(e)}finally{this.loading=!1}},async loadRequirements(){if(this.selectedProject)try{const e=await i.ApiService.progress.getRequirements(this.selectedProject.id);this.requirements=e}catch(e){console.error("加载需求失败:",e),this.requirements=[]}},async onProjectChange(e){this.selectedProjectIndex=e.detail.value,this.selectedProject=this.projects[this.selectedProjectIndex],await this.loadRequirements()},onStatusChange(e){this.statusIndex=e.detail.value,this.requirementForm.status=this.statusMap[this.statusIndex]},onPriorityChange(e){this.priorityIndex=e.detail.value,this.requirementForm.priority=this.priorityMap[this.priorityIndex]},onTemplateChange(e){if(this.templateIndex=e.detail.value,this.templateIndex>=0&&this.templateOptions[this.templateIndex]){const e=this.templateOptions[this.templateIndex];this.requirementForm.template_id=e.id,this.requirementForm.title=e.title_template.replace("{项目名称}",this.selectedProject.title),this.requirementForm.description=e.description_template.replace("{项目名称}",this.selectedProject.title)}},showAddRequirementModal(){this.selectedProject?(this.isEditing=!1,this.requirementForm={title:"",description:"",status:"pending",priority:"medium",estimated_hours:"",assignee:"",assignee_id:null,template_id:null},this.statusIndex=0,this.priorityIndex=1,this.templateIndex=-1,this.showRequirementModal=!0):e.index.showToast({title:"请先选择项目",icon:"none"})},editRequirement(e){this.isEditing=!0,this.editingRequirementId=e.id;const t=this.getAssigneeInfo(e.assignee_id);this.requirementForm={title:e.title,description:e.description,status:e.status,priority:e.priority||"medium",estimated_hours:e.estimated_hours||"",assignee:t?t.nickname:"",assignee_id:e.assignee_id||null,template_id:e.template_id||null};const i=Object.keys(this.statusMap).findIndex((t=>this.statusMap[t]===e.status));this.statusIndex=i>=0?i:0;const r=Object.keys(this.priorityMap).findIndex((t=>this.priorityMap[t]===(e.priority||"medium")));if(this.priorityIndex=r>=0?r:1,e.template_id){const t=this.templateOptions.findIndex((t=>t.id===e.template_id));this.templateIndex=t>=0?t:-1}else this.templateIndex=-1;this.showRequirementModal=!0},closeRequirementModal(){this.showRequirementModal=!1,this.isEditing=!1,this.editingRequirementId=null},async saveRequirement(){if(this.canSave)if(this.isSaving)console.log("正在保存中，请勿重复提交");else{this.isSaving=!0;try{const t={project_id:this.selectedProject.id,title:this.requirementForm.title.trim(),description:this.requirementForm.description.trim(),status:this.requirementForm.status,priority:this.requirementForm.priority,estimated_hours:this.requirementForm.estimated_hours?parseFloat(this.requirementForm.estimated_hours):null,assignee:this.requirementForm.assignee||null,assignee_id:this.requirementForm.assignee_id||null,template_id:this.requirementForm.template_id||null};console.log("保存需求 - isEditing:",this.isEditing,"editingRequirementId:",this.editingRequirementId),this.isEditing?(console.log("执行更新操作，ID:",this.editingRequirementId),await i.ApiService.progress.updateRequirement(this.editingRequirementId,t),e.index.showToast({title:"需求更新成功",icon:"success"})):(console.log("执行创建操作"),await i.ApiService.progress.createRequirement(t),e.index.showToast({title:"需求添加成功",icon:"success"})),this.closeRequirementModal(),await this.loadRequirements()}catch(t){console.error("保存需求失败:",t),i.ApiErrorHandler.handle(t)}finally{this.isSaving=!1}}else e.index.showToast({title:"请填写完整信息",icon:"none"})},deleteRequirement(e){this.deletingRequirementId=e,this.showDeleteModal=!0},closeDeleteModal(){this.showDeleteModal=!1,this.deletingRequirementId=null},async confirmDelete(){try{await i.ApiService.progress.deleteRequirement(this.deletingRequirementId),e.index.showToast({title:"删除成功",icon:"success"}),this.closeDeleteModal(),await this.loadRequirements()}catch(t){i.ApiErrorHandler.handle(t)}},getRequirementCount(e){return this.requirements.filter((t=>t.status===e)).length},getStatusText:e=>({pending:"未开始",progress:"进行中",completed:"已完成"}[e]||"未知"),formatDate(e){if(!e)return"";return new Date(e).toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})},getPriorityText:e=>({low:"低",medium:"中",high:"高"}[e]||"中"),async showRequirementDetail(e){try{const t=await i.ApiService.progress.getRequirementDetail(e.id);this.currentRequirement=t,this.showDetailModal=!0}catch(t){i.ApiErrorHandler.handle(t)}},closeDetailModal(){this.showDetailModal=!1,this.currentRequirement=null},editFromDetail(){this.closeDetailModal(),this.editRequirement(this.currentRequirement)},formatFileSize(e){if(!e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]},downloadAttachment(t){e.index.showToast({title:"下载功能待实现",icon:"none"})},async deleteAttachment(t){try{await i.ApiService.progress.deleteAttachment(t),e.index.showToast({title:"附件删除成功",icon:"success"}),this.currentRequirement&&await this.showRequirementDetail(this.currentRequirement)}catch(r){i.ApiErrorHandler.handle(r)}},getTimeDeviation(e,t){const i=t-e;return i>0?`+${i.toFixed(1)}小时`:i<0?`${i.toFixed(1)}小时`:"0小时"},getTimeDeviationClass(e,t){const i=t-e;return i>0?"time-over":i<0?"time-under":"time-exact"},openAssigneeModal(){this.showAssigneeModal=!0},closeAssigneeModal(){this.showAssigneeModal=!1},selectAssignee(e){this.requirementForm.assignee=e.nickname,this.requirementForm.assignee_id=e.id},confirmAssignee(){this.closeAssigneeModal()},setFilter(e){this.currentFilter=e},getFilterText:e=>({all:"全部",pending:"未开始",progress:"进行中",completed:"已完成"}[e]||"全部"),getAssigneeInfo(e){return e?this.assigneeOptions.find((t=>t.id===e)):null}},onLoad(){const t=e.index.getStorageSync("wechat_token"),i=e.index.getStorageSync("userInfo");return t&&i?"admin"!==i.user_type?(e.index.showToast({title:"无管理员权限",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3)):void this.loadProgressData():(e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3))}};const s=e._export_sfc(r,[["render",function(t,i,r,s,n,o){var a;return e.e({a:o.getStaticUrl("/static/svg/left.svg"),b:e.o(((...e)=>o.goBack&&o.goBack(...e))),c:e.o(((...e)=>o.showAddRequirementModal&&o.showAddRequirementModal(...e))),d:n.loading},n.loading?{}:n.error?{f:e.t(n.error),g:e.o(((...e)=>o.loadProgressData&&o.loadProgressData(...e)))}:e.e({h:e.t(n.selectedProject?n.selectedProject.title:"请选择项目"),i:n.selectedProjectIndex,j:n.projects,k:e.o(((...e)=>o.onProjectChange&&o.onProjectChange(...e))),l:n.selectedProject},n.selectedProject?e.e({m:e.t(n.requirements.length),n:"all"===n.currentFilter?1:"",o:e.o((e=>o.setFilter("all"))),p:e.t(o.getRequirementCount("pending")),q:"pending"===n.currentFilter?1:"",r:e.o((e=>o.setFilter("pending"))),s:e.t(o.getRequirementCount("progress")),t:"progress"===n.currentFilter?1:"",v:e.o((e=>o.setFilter("progress"))),w:e.t(o.getRequirementCount("completed")),x:"completed"===n.currentFilter?1:"",y:e.o((e=>o.setFilter("completed"))),z:e.f(o.filteredRequirements,((t,i,r)=>{var s;return e.e({a:e.t(t.title),b:e.o((e=>o.showRequirementDetail(t)),t.id),c:e.o((e=>o.editRequirement(t)),t.id),d:e.o((e=>o.deleteRequirement(t.id)),t.id),e:e.t(t.description),f:e.t(o.getPriorityText(t.priority||"medium")),g:e.n(`priority-${t.priority||"medium"}`),h:t.assignee_id},t.assignee_id?{i:e.t((null==(s=o.getAssigneeInfo(t.assignee_id))?void 0:s.nickname)||"未知")}:{},{j:e.t(t.estimated_hours||0),k:e.t(t.actual_hours||0),l:e.t(o.getStatusText(t.status)),m:e.n(`status-${t.status}`),n:e.t(o.formatDate(t.create_time)),o:t.update_time},t.update_time?{p:e.t(o.formatDate(t.update_time))}:{},{q:t.id})})),A:0===o.filteredRequirements.length},0===o.filteredRequirements.length?{B:e.t("all"===n.currentFilter?"暂无需求，点击上方按钮添加需求":`暂无${o.getFilterText(n.currentFilter)}的需求`)}:{}):{}),{e:n.error,C:n.showRequirementModal},n.showRequirementModal?{D:e.t(n.isEditing?"编辑需求":"添加需求"),E:e.o(((...e)=>o.closeRequirementModal&&o.closeRequirementModal(...e))),F:e.t(n.templateOptions[n.templateIndex]?n.templateOptions[n.templateIndex].name:"选择模板"),G:n.templateIndex,H:n.templateOptions,I:e.o(((...e)=>o.onTemplateChange&&o.onTemplateChange(...e))),J:n.requirementForm.title,K:e.o((e=>n.requirementForm.title=e.detail.value)),L:n.requirementForm.description,M:e.o((e=>n.requirementForm.description=e.detail.value)),N:e.t(n.priorityOptions[n.priorityIndex]),O:n.priorityIndex,P:n.priorityOptions,Q:e.o(((...e)=>o.onPriorityChange&&o.onPriorityChange(...e))),R:e.t(n.statusOptions[n.statusIndex]),S:n.statusIndex,T:n.statusOptions,U:e.o(((...e)=>o.onStatusChange&&o.onStatusChange(...e))),V:n.requirementForm.estimated_hours,W:e.o((e=>n.requirementForm.estimated_hours=e.detail.value)),X:e.t(n.requirementForm.assignee||"请选择负责人"),Y:e.o(((...e)=>o.openAssigneeModal&&o.openAssigneeModal(...e))),Z:e.o(((...e)=>o.closeRequirementModal&&o.closeRequirementModal(...e))),aa:e.t(n.isSaving?"保存中...":"保存"),ab:e.o(((...e)=>o.saveRequirement&&o.saveRequirement(...e))),ac:!o.canSave||n.isSaving,ad:e.o((()=>{})),ae:e.o(((...e)=>o.closeRequirementModal&&o.closeRequirementModal(...e)))}:{},{af:n.showDetailModal},n.showDetailModal?e.e({ag:e.o(((...e)=>o.closeDetailModal&&o.closeDetailModal(...e))),ah:n.currentRequirement},n.currentRequirement?e.e({ai:e.t(n.currentRequirement.title),aj:e.t(n.currentRequirement.description),ak:e.t(o.getPriorityText(n.currentRequirement.priority||"medium")),al:e.n(`priority-${n.currentRequirement.priority||"medium"}`),am:e.t(o.getStatusText(n.currentRequirement.status)),an:e.n(`status-${n.currentRequirement.status}`),ao:n.currentRequirement.assignee_id},n.currentRequirement.assignee_id?{ap:e.t((null==(a=o.getAssigneeInfo(n.currentRequirement.assignee_id))?void 0:a.nickname)||"未知")}:{},{aq:e.t(n.currentRequirement.estimated_hours||0),ar:e.t(n.currentRequirement.actual_hours||0),as:n.currentRequirement.estimated_hours&&n.currentRequirement.actual_hours},n.currentRequirement.estimated_hours&&n.currentRequirement.actual_hours?{at:e.t(o.getTimeDeviation(n.currentRequirement.estimated_hours,n.currentRequirement.actual_hours)),av:e.n(o.getTimeDeviationClass(n.currentRequirement.estimated_hours,n.currentRequirement.actual_hours))}:{},{aw:n.currentRequirement.attachments&&n.currentRequirement.attachments.length>0},n.currentRequirement.attachments&&n.currentRequirement.attachments.length>0?{ax:e.f(n.currentRequirement.attachments,((t,i,r)=>({a:e.t(t.original_name),b:e.t(o.formatFileSize(t.file_size)),c:e.o((e=>o.downloadAttachment(t)),t.id),d:e.o((e=>o.deleteAttachment(t.id)),t.id),e:t.id})))}:{},{ay:n.currentRequirement.comments&&n.currentRequirement.comments.length>0},n.currentRequirement.comments&&n.currentRequirement.comments.length>0?{az:e.f(n.currentRequirement.comments,((t,i,r)=>({a:o.getStaticUrl(t.author_avatar),b:e.t(t.author),c:e.t(o.formatDate(t.create_time)),d:e.t(t.content),e:t.id})))}:{},{aA:n.currentRequirement.time_logs&&n.currentRequirement.time_logs.length>0},n.currentRequirement.time_logs&&n.currentRequirement.time_logs.length>0?{aB:e.f(n.currentRequirement.time_logs,((t,i,r)=>e.e({a:e.t(t.log_date),b:e.t(t.hours),c:t.description},t.description?{d:e.t(t.description)}:{},{e:e.t(t.user_name),f:t.id})))}:{}):{},{aC:e.o(((...e)=>o.closeDetailModal&&o.closeDetailModal(...e))),aD:e.o(((...e)=>o.editFromDetail&&o.editFromDetail(...e))),aE:e.o((()=>{})),aF:e.o(((...e)=>o.closeDetailModal&&o.closeDetailModal(...e)))}):{},{aG:n.showAssigneeModal},n.showAssigneeModal?{aH:e.o(((...e)=>o.closeAssigneeModal&&o.closeAssigneeModal(...e))),aI:e.f(n.assigneeOptions,((t,i,r)=>e.e({a:o.getStaticUrl(t.avatar_url),b:e.t(t.nickname),c:n.requirementForm.assignee===t.nickname},(n.requirementForm.assignee,t.nickname,{}),{d:t.id,e:n.requirementForm.assignee===t.nickname?1:"",f:e.o((e=>o.selectAssignee(t)),t.id)}))),aJ:e.o(((...e)=>o.closeAssigneeModal&&o.closeAssigneeModal(...e))),aK:e.o(((...e)=>o.confirmAssignee&&o.confirmAssignee(...e))),aL:e.o((()=>{})),aM:e.o(((...e)=>o.closeAssigneeModal&&o.closeAssigneeModal(...e)))}:{},{aN:n.showDeleteModal},n.showDeleteModal?{aO:e.o(((...e)=>o.closeDeleteModal&&o.closeDeleteModal(...e))),aP:e.o(((...e)=>o.closeDeleteModal&&o.closeDeleteModal(...e))),aQ:e.o(((...e)=>o.confirmDelete&&o.confirmDelete(...e))),aR:e.o((()=>{})),aS:e.o(((...e)=>o.closeDeleteModal&&o.closeDeleteModal(...e)))}:{})}]]);wx.createPage(s);
