"use strict";const e=require("../../common/vendor.js"),t=require("../../config/config.js"),s=require("../../utils/api.js"),i={data:()=>({showSuccess:!1,loading:!1,projectsPerPageIndex:1,sessionTimeoutIndex:1,backupFrequencyIndex:1,projectsPerPageOptions:["6个","9个","12个","15个"],sessionTimeoutOptions:["30分钟","1小时","2小时","4小时","8小时"],backupFrequencyOptions:["每天","每周","每月"],settings:{siteName:"解忧青年作品集",siteDescription:"一位热衷于创建视觉元素、主题制作和嵌入式开发的全栈工程师。",siteKeywords:"作品集,前端开发,Vue,React,项目展示",subdescription:"乔布斯于科技世界种下创新种子，罗永浩在行业浪潮里坚守情怀高地，都让我着迷。我仿佛看到老罗和乔布斯在科技和人文的十字路口探讨人生，所以我带着这份情怀，期待在这里与你相遇。",projectsPerPage:9,enableComments:!0,enableSharing:!0,loginLock:!0,sessionTimeout:3600,autoBackup:!0,backupFrequency:"weekly"},systemInfo:{version:"1.0.0",phpVersion:"8.0.0",dbVersion:"MySQL 8.0",serverTime:(new Date).toLocaleString(),uptime:"15天 8小时 32分钟"}}),async onLoad(){const t=e.index.getStorageSync("wechat_token"),s=e.index.getStorageSync("userInfo");return t&&s?"admin"!==s.user_type?(e.index.showToast({title:"无管理员权限",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3)):(await this.loadSettings(),void(await this.loadSystemInfo())):(e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3))},methods:{getStaticUrl:e=>t.CONFIG_UTILS.getStaticUrl(e),goBack(){e.index.navigateBack()},async loadSettings(){var e,t,i,n,o,a,r,c,g,u,d;try{this.loading=!0;const l=await s.ApiService.setting.getSettings();l&&(this.settings.siteName=(null==(e=l.site_name)?void 0:e.value)||this.settings.siteName,this.settings.siteDescription=(null==(t=l.site_description)?void 0:t.value)||this.settings.siteDescription,this.settings.siteKeywords=(null==(i=l.site_keywords)?void 0:i.value)||this.settings.siteKeywords,this.settings.subdescription=(null==(n=l.subdescription)?void 0:n.value)||this.settings.subdescription,this.settings.projectsPerPage=(null==(o=l.projects_per_page)?void 0:o.value)||this.settings.projectsPerPage,this.settings.enableComments=(null==(a=l.enable_comments)?void 0:a.value)||this.settings.enableComments,this.settings.enableSharing=(null==(r=l.enable_sharing)?void 0:r.value)||this.settings.enableSharing,this.settings.loginLock=(null==(c=l.login_lock)?void 0:c.value)||this.settings.loginLock,this.settings.sessionTimeout=(null==(g=l.session_timeout)?void 0:g.value)||this.settings.sessionTimeout,this.settings.autoBackup=(null==(u=l.auto_backup)?void 0:u.value)||this.settings.autoBackup,this.settings.backupFrequency=(null==(d=l.backup_frequency)?void 0:d.value)||this.settings.backupFrequency,this.updatePickerIndexes())}catch(l){console.error("加载设置失败:",l),s.ApiErrorHandler.handle(l)}finally{this.loading=!1}},async loadSystemInfo(){try{const e=await s.ApiService.setting.getSystemInfo();e&&(this.systemInfo={version:e.version||"1.0.0",phpVersion:e.php_version||"8.0.0",dbVersion:e.database_version||"MySQL 8.0",serverTime:e.server_time||(new Date).toLocaleString(),uptime:e.uptime||"15天 8小时 32分钟"})}catch(e){console.error("加载系统信息失败:",e),s.ApiErrorHandler.handleSilent(e)}},updatePickerIndexes(){this.projectsPerPageIndex=[6,9,12,15].indexOf(this.settings.projectsPerPage),-1===this.projectsPerPageIndex&&(this.projectsPerPageIndex=1);this.sessionTimeoutIndex=[1800,3600,7200,14400,28800].indexOf(this.settings.sessionTimeout),-1===this.sessionTimeoutIndex&&(this.sessionTimeoutIndex=1);this.backupFrequencyIndex=["daily","weekly","monthly"].indexOf(this.settings.backupFrequency),-1===this.backupFrequencyIndex&&(this.backupFrequencyIndex=1)},onProjectsPerPageChange(e){this.projectsPerPageIndex=e.detail.value,this.settings.projectsPerPage=3*(e.detail.value+1)},onCommentsChange(e){this.settings.enableComments=e.detail.value},onSharingChange(e){this.settings.enableSharing=e.detail.value},onLoginLockChange(e){this.settings.loginLock=e.detail.value},onSessionTimeoutChange(e){this.sessionTimeoutIndex=e.detail.value;this.settings.sessionTimeout=[1800,3600,7200,14400,28800][e.detail.value]},onAutoBackupChange(e){this.settings.autoBackup=e.detail.value},onBackupFrequencyChange(e){this.backupFrequencyIndex=e.detail.value;this.settings.backupFrequency=["daily","weekly","monthly"][e.detail.value]},async saveSettings(){try{e.index.showLoading({title:"保存中..."});const t={site_name:this.settings.siteName,site_description:this.settings.siteDescription,site_keywords:this.settings.siteKeywords,subdescription:this.settings.subdescription,projects_per_page:this.settings.projectsPerPage,enable_comments:this.settings.enableComments,enable_sharing:this.settings.enableSharing,login_lock:this.settings.loginLock,session_timeout:this.settings.sessionTimeout,auto_backup:this.settings.autoBackup,backup_frequency:this.settings.backupFrequency};await s.ApiService.setting.updateSettings(t),e.index.hideLoading(),this.showSuccess=!0,setTimeout((()=>{this.showSuccess=!1}),3e3),e.index.showToast({title:"设置保存成功",icon:"success"})}catch(t){e.index.hideLoading(),console.error("保存设置失败:",t),s.ApiErrorHandler.handle(t)}},async backupData(){e.index.showModal({title:"备份数据",content:"确定要备份当前所有数据吗？",success:async t=>{if(t.confirm)try{e.index.showLoading({title:"备份中..."});const t=await s.ApiService.setting.backupData();e.index.hideLoading(),e.index.showToast({title:"备份完成",icon:"success"}),console.log("备份结果:",t)}catch(i){e.index.hideLoading(),console.error("备份失败:",i),s.ApiErrorHandler.handle(i)}}})},async restoreData(){try{const t=await s.ApiService.setting.getBackupList();if(!t||0===t.length)return void e.index.showToast({title:"没有找到备份文件",icon:"none"});const i=t.map((e=>e.filename));e.index.showActionSheet({itemList:i,success:async i=>{const n=t[i.tapIndex];e.index.showModal({title:"恢复数据",content:`确定要恢复备份文件 "${n.filename}" 吗？这将覆盖当前所有数据！`,success:async t=>{if(t.confirm)try{e.index.showLoading({title:"恢复中..."}),await s.ApiService.setting.restoreData(n.filepath),e.index.hideLoading(),e.index.showToast({title:"恢复完成",icon:"success"})}catch(i){e.index.hideLoading(),console.error("恢复失败:",i),s.ApiErrorHandler.handle(i)}}})}})}catch(t){console.error("获取备份列表失败:",t),s.ApiErrorHandler.handle(t)}},async clearCache(){e.index.showModal({title:"清除缓存",content:"确定要清除系统缓存吗？",success:async t=>{if(t.confirm)try{e.index.showLoading({title:"清除中..."}),await s.ApiService.setting.clearCache(),e.index.hideLoading(),e.index.showToast({title:"缓存已清除",icon:"success"})}catch(i){e.index.hideLoading(),console.error("清除缓存失败:",i),s.ApiErrorHandler.handle(i)}}})}}};const n=e._export_sfc(i,[["render",function(t,s,i,n,o,a){return e.e({a:a.getStaticUrl("/static/svg/left.svg"),b:e.o(((...e)=>a.goBack&&a.goBack(...e))),c:e.o(((...e)=>a.saveSettings&&a.saveSettings(...e))),d:o.settings.siteName,e:e.o((e=>o.settings.siteName=e.detail.value)),f:o.settings.siteDescription,g:e.o((e=>o.settings.siteDescription=e.detail.value)),h:o.settings.subdescription,i:e.o((e=>o.settings.subdescription=e.detail.value)),j:o.settings.siteKeywords,k:e.o((e=>o.settings.siteKeywords=e.detail.value)),l:e.t(o.projectsPerPageOptions[o.projectsPerPageIndex]),m:e.o(((...e)=>a.onProjectsPerPageChange&&a.onProjectsPerPageChange(...e))),n:o.projectsPerPageIndex,o:o.projectsPerPageOptions,p:o.settings.enableComments,q:e.o(((...e)=>a.onCommentsChange&&a.onCommentsChange(...e))),r:o.settings.enableSharing,s:e.o(((...e)=>a.onSharingChange&&a.onSharingChange(...e))),t:o.settings.loginLock,v:e.o(((...e)=>a.onLoginLockChange&&a.onLoginLockChange(...e))),w:e.t(o.sessionTimeoutOptions[o.sessionTimeoutIndex]),x:e.o(((...e)=>a.onSessionTimeoutChange&&a.onSessionTimeoutChange(...e))),y:o.sessionTimeoutIndex,z:o.sessionTimeoutOptions,A:o.settings.autoBackup,B:e.o(((...e)=>a.onAutoBackupChange&&a.onAutoBackupChange(...e))),C:e.t(o.backupFrequencyOptions[o.backupFrequencyIndex]),D:e.o(((...e)=>a.onBackupFrequencyChange&&a.onBackupFrequencyChange(...e))),E:o.backupFrequencyIndex,F:o.backupFrequencyOptions,G:e.t(o.systemInfo.version),H:e.t(o.systemInfo.phpVersion),I:e.t(o.systemInfo.dbVersion),J:e.t(o.systemInfo.serverTime),K:e.t(o.systemInfo.uptime),L:a.getStaticUrl("/static/svg/server.svg"),M:e.o(((...e)=>a.backupData&&a.backupData(...e))),N:a.getStaticUrl("/static/svg/restore.svg"),O:e.o(((...e)=>a.restoreData&&a.restoreData(...e))),P:a.getStaticUrl("/static/svg/clear.svg"),Q:e.o(((...e)=>a.clearCache&&a.clearCache(...e))),R:o.showSuccess},(o.showSuccess,{}))}]]);wx.createPage(n);
