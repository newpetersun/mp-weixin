"use strict";const e=require("../../common/vendor.js"),t=require("../../config/config.js"),o=require("../../utils/api.js"),i={data:()=>({searchKeyword:"",showFilter:!1,showProjectModal:!1,isEdit:!1,loading:!1,error:null,categoryIndex:0,statusIndex:0,formCategoryIndex:0,formStatusIndex:0,formClientIndex:0,categoryOptions:["全部分类"],statusOptions:["全部状态","已发布","草稿"],projectForm:{id:null,title:"",description:"",category:"Web开发",status:"published",client:null,client_id:null,tags:[],tagsInput:"",technologies:[],image:"/static/images/projects/default.jpg",images:[],createTime:""},imageError:"",projects:[],showTechnologySelector:!1,techSearchKeyword:"",allTechnologies:[],tempSelectedTechnologies:[],showClientSelector:!1,clientSearchKeyword:"",clientOptions:[],selectedClient:null,tempSelectedClient:null}),computed:{filteredProjects(){let e=this.projects;if(this.searchKeyword&&(e=e.filter((e=>e.title.toLowerCase().includes(this.searchKeyword.toLowerCase())||e.description.toLowerCase().includes(this.searchKeyword.toLowerCase())))),this.categoryIndex>0){const t=this.categoryOptions[this.categoryIndex];e=e.filter((e=>e.category===t))}if(this.statusIndex>0){const t=1===this.statusIndex?"published":"draft";e=e.filter((e=>e.status===t))}return e},filteredTechnologies(){return this.techSearchKeyword?this.allTechnologies.filter((e=>e.name.toLowerCase().includes(this.techSearchKeyword.toLowerCase()))):this.allTechnologies},filteredClients(){return this.clientSearchKeyword?this.clientOptions.filter((e=>e.name.toLowerCase().includes(this.clientSearchKeyword.toLowerCase())||e.contact&&e.contact.toLowerCase().includes(this.clientSearchKeyword.toLowerCase())||e.phone&&e.phone.includes(this.clientSearchKeyword))):this.clientOptions}},methods:{getStaticUrl:e=>t.CONFIG_UTILS.getStaticUrl(e),goBack(){e.index.navigateBack()},handleSearch(){},onCategoryChange(e){this.categoryIndex=e.detail.value},onStatusChange(e){this.statusIndex=e.detail.value},onFormCategoryChange(e){this.formCategoryIndex=e.detail.value,this.projectForm.category=this.categoryOptions[e.detail.value+1]},onFormStatusChange(e){this.formStatusIndex=e.detail.value,this.projectForm.status="已发布"===this.statusOptions[e.detail.value+1]?"published":"draft"},addProject(){this.isEdit=!1,this.projectForm={id:null,title:"",description:"",category:"Web开发",status:"published",client:null,client_id:null,tags:[],tagsInput:"",technologies:[],image:"/static/images/projects/default.jpg",images:[],createTime:""},this.imageError="",this.formCategoryIndex=0,this.formStatusIndex=0,this.formClientIndex=0,this.showProjectModal=!0},editProject(e){this.isEdit=!0;let t=[];e.images?t=Array.isArray(e.images)?[...e.images]:[e.image]:e.image&&"/static/images/projects/default.jpg"!==e.image&&(t=[e.image]);let o=[];e.technologies&&(o=Array.isArray(e.technologies)?[...e.technologies]:[]);let i=null;e.client_id&&(i=this.clientOptions.find((t=>t.id===e.client_id))||null),this.projectForm={...e,tagsInput:e.tags.join(","),images:t,technologies:o,client:i},this.imageError="",this.formCategoryIndex=this.categoryOptions.indexOf(e.category)-1,this.formStatusIndex="published"===e.status?0:1,this.formClientIndex=i?this.clientOptions.findIndex((e=>e.id===i.id)):0,this.showProjectModal=!0},deleteProject(t){e.index.showModal({title:"确认删除",content:`确定要删除项目 "${t.title}" 吗？`,success:o=>{o.confirm&&(this.projects=this.projects.filter((e=>e.id!==t.id)),e.index.showToast({title:"删除成功",icon:"success"}))}})},closeProjectModal(){this.showProjectModal=!1},async saveProject(){if(this.projectForm.title&&this.projectForm.description){if(0===this.projectForm.images.length)return this.imageError="请至少上传一张项目图片",void e.index.showToast({title:"请至少上传一张项目图片",icon:"none"});this.projectForm.tags=this.projectForm.tagsInput.split(",").map((e=>e.trim())).filter((e=>e));try{if(this.isEdit)await o.ApiService.project.update(this.projectForm.id,{title:this.projectForm.title,description:this.projectForm.description,full_description:this.projectForm.description,category_id:this.getCategoryId(this.projectForm.category),client_id:this.projectForm.client_id,tags:this.projectForm.tags,technologies:(this.projectForm.technologies||[]).map((e=>e.name)),features:this.projectForm.features||[],status:"published"===this.projectForm.status?1:0,sort_order:this.projectForm.sort_order||0,is_featured:this.projectForm.is_featured||0,image:this.projectForm.images[0],images:this.projectForm.images}),e.index.showToast({title:"更新成功",icon:"success"});else{const t=await o.ApiService.project.create({title:this.projectForm.title,description:this.projectForm.description,full_description:this.projectForm.description,category_id:this.getCategoryId(this.projectForm.category),client_id:this.projectForm.client_id,tags:this.projectForm.tags,technologies:(this.projectForm.technologies||[]).map((e=>e.name)),features:this.projectForm.features||[],status:"published"===this.projectForm.status?1:0,sort_order:this.projectForm.sort_order||0,is_featured:this.projectForm.is_featured||0,image:this.projectForm.images[0],images:this.projectForm.images});this.projects.unshift(t),e.index.showToast({title:"添加成功",icon:"success"})}this.closeProjectModal(),this.loadProjectData()}catch(t){o.ApiErrorHandler.handle(t)}}else e.index.showToast({title:"请填写完整信息",icon:"none"})},async deleteProject(t){e.index.showModal({title:"确认删除",content:`确定要删除项目 "${t.title}" 吗？`,success:async i=>{if(i.confirm)try{await o.ApiService.project.delete(t.id),this.projects=this.projects.filter((e=>e.id!==t.id)),e.index.showToast({title:"删除成功",icon:"success"})}catch(s){o.ApiErrorHandler.handle(s)}}})},async loadProjectData(){this.loading=!0,this.error=null;try{const[e,t]=await Promise.all([o.ApiService.project.getList(),o.ApiService.project.getCategories()]);console.log("项目响应:",e),console.log("分类响应:",t);const i=e.list||e;this.projects=this.validateProjects(i);const s=t||[];this.categoryOptions=["全部分类",...s.map((e=>e.name))]}catch(e){this.error=e.message||"数据加载失败",o.ApiErrorHandler.handle(e)}finally{this.loading=!1}},validateProjects(e){return Array.isArray(e)?e.map((e=>({id:e.id,title:e.title||"未命名项目",description:e.description||"暂无描述",fullDescription:e.full_description||e.description,image:Array.isArray(e.image)&&e.image.length>0?e.image[0]:e.image||"/static/images/default-project.png",images:Array.isArray(e.image)?e.image:e.image?[e.image]:[],category:this.getCategoryName(e.category_id),category_id:e.category_id,client_id:e.client_id||null,client:e.client||null,status:1===e.status?"published":"draft",tags:Array.isArray(e.tags)?e.tags:[],technologies:Array.isArray(e.technologies)?e.technologies:[],features:Array.isArray(e.features)?e.features:[],createTime:e.create_time||e.createTime||"未知时间",sort_order:e.sort_order||0,is_featured:e.is_featured||0}))):(console.warn("项目数据不是数组格式:",e),[])},getCategoryName(e){if(!e)return"其他";return{1:"Web开发",2:"移动开发",3:"UI设计",4:"数据分析"}[e]||"其他"},getCategoryId:e=>({"Web开发":1,"移动开发":2,"UI设计":3,"数据分析":4}[e]||1),chooseImage(){this.imageError="",e.index.chooseImage({count:9-this.projectForm.images.length,sizeType:["original","compressed"],sourceType:["album","camera"],success:async e=>{for(let o=0;o<e.tempFilePaths.length;o++)try{const t=e.tempFilePaths[o];if(e.tempFiles[o].size>5242880){this.imageError="图片大小不能超过5MB";continue}const i=await this.uploadProjectImage(t);this.projectForm.images.push(i.url),1===this.projectForm.images.length&&(this.projectForm.image=i.url)}catch(t){this.imageError="图片上传失败，请重试",console.error("图片上传失败:",t)}}})},removeImage(e){this.projectForm.images.splice(e,1),0===e&&this.projectForm.images.length>0?this.projectForm.image=this.projectForm.images[0]:0===this.projectForm.images.length&&(this.projectForm.image="/static/images/projects/default.jpg")},uploadProjectImage:async o=>new Promise(((i,s)=>{e.index.uploadFile({url:t.CONFIG_UTILS.getApiUrl("/project/upload-image"),filePath:o,name:"image",header:{Authorization:"Bearer "+e.index.getStorageSync("wechat_token")},success:e=>{try{const t=JSON.parse(e.data);200===t.code?i(t.data):s(new Error(t.message||"上传失败"))}catch(t){s(new Error("上传响应解析失败"))}},fail:e=>{s(e)}})})),async updateProjectStatus(t,i){try{await o.ApiService.project.updateStatus(t.id,"published"===i?1:0),t.status=i,e.index.showToast({title:"状态更新成功",icon:"success"})}catch(s){o.ApiErrorHandler.handle(s)}},async loadTechnologies(){try{const e=await o.ApiService.technology.getList();this.allTechnologies=e.list||e}catch(e){console.error("加载技术列表失败:",e)}},async loadClients(){try{const e=await o.ApiService.client.getList();this.clientOptions=e.list||e,console.log("加载客户列表成功:",this.clientOptions)}catch(e){console.error("加载客户列表失败:",e),this.clientOptions=[{id:1,name:"腾讯科技",contact:"张经理",phone:"13800138000"},{id:2,name:"阿里巴巴",contact:"李经理",phone:"13900139000"},{id:3,name:"百度科技",contact:"王经理",phone:"13700137000"}]}},openTechnologySelector(){this.tempSelectedTechnologies=[...this.projectForm.technologies],this.techSearchKeyword="",this.showTechnologySelector=!0},closeTechnologySelector(){this.showTechnologySelector=!1,this.techSearchKeyword=""},isTechnologySelected(e){return this.tempSelectedTechnologies.some((t=>t.id===e.id))},toggleTechnology(e){const t=this.tempSelectedTechnologies.findIndex((t=>t.id===e.id));t>-1?this.tempSelectedTechnologies.splice(t,1):this.tempSelectedTechnologies.push(e)},confirmTechnologySelection(){this.projectForm.technologies=[...this.tempSelectedTechnologies],this.closeTechnologySelector()},removeTechnology(e){const t=this.projectForm.technologies.findIndex((t=>t.id===e.id));t>-1&&this.projectForm.technologies.splice(t,1)}},onFormClientChange(e){this.formClientIndex=e.detail.value,this.projectForm.client=this.clientOptions[e.detail.value],this.projectForm.client_id=this.clientOptions[e.detail.value].id},openClientSelector(){this.tempSelectedClient=this.projectForm.client,this.clientSearchKeyword="",this.showClientSelector=!0},closeClientSelector(){this.showClientSelector=!1,this.clientSearchKeyword=""},selectClient(e){this.tempSelectedClient=e},confirmClientSelection(){this.projectForm.client=this.tempSelectedClient,this.tempSelectedClient?this.projectForm.client_id=this.tempSelectedClient.id:this.projectForm.client_id=null,this.closeClientSelector()},isClientSelected(e){return this.tempSelectedClient&&this.tempSelectedClient.id===e.id},async loadClients(){try{const e=await o.ApiService.client.getList();this.clientOptions=e.list||e}catch(e){console.error("加载客户列表失败:",e),this.clientOptions=[{id:1,name:"腾讯科技",contact:"张经理",phone:"13800138000"},{id:2,name:"阿里巴巴",contact:"李经理",phone:"13900139000"},{id:3,name:"百度科技",contact:"王经理",phone:"13700137000"}]}},onLoad(){const t=e.index.getStorageSync("wechat_token"),o=e.index.getStorageSync("userInfo");return t&&o?"admin"!==o.user_type?(e.index.showToast({title:"无管理员权限",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3)):(this.loadProjectData(),this.loadTechnologies(),void this.loadClients()):(e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3))},onShow(){this.loadProjectData()}};const s=e._export_sfc(i,[["render",function(t,o,i,s,r,c){return e.e({a:c.getStaticUrl("/static/svg/left.svg"),b:e.o(((...e)=>c.goBack&&c.goBack(...e))),c:e.o(((...e)=>c.addProject&&c.addProject(...e))),d:r.loading},r.loading?{}:r.error?{f:e.t(r.error),g:e.o(((...e)=>c.loadProjectData&&c.loadProjectData(...e)))}:e.e({h:c.getStaticUrl("/static/svg/search.svg"),i:e.o([e=>r.searchKeyword=e.detail.value,(...e)=>c.handleSearch&&c.handleSearch(...e)]),j:r.searchKeyword,k:c.getStaticUrl("/static/svg/filter.svg"),l:e.o((e=>r.showFilter=!r.showFilter)),m:r.showFilter},r.showFilter?{n:e.t(r.categoryOptions[r.categoryIndex]),o:e.o(((...e)=>c.onCategoryChange&&c.onCategoryChange(...e))),p:r.categoryIndex,q:r.categoryOptions,r:e.t(r.statusOptions[r.statusIndex]),s:e.o(((...e)=>c.onStatusChange&&c.onStatusChange(...e))),t:r.statusIndex,v:r.statusOptions}:{},{w:e.f(c.filteredProjects,((t,o,i)=>e.e({a:c.getStaticUrl(t.image||"/static/images/default-project.png"),b:e.t("published"===t.status?"已发布":"草稿"),c:e.n("published"===t.status?"status-published":"status-draft"),d:e.o((e=>c.updateProjectStatus(t,"published"===t.status?"draft":"published")),t.id),e:e.t(t.title),f:e.t(t.description),g:e.t(t.category),h:e.t(t.createTime),i:e.f(t.tags,((t,o,i)=>({a:e.t(t),b:t}))),j:t.technologies&&t.technologies.length>0},t.technologies&&t.technologies.length>0?{k:e.f(t.technologies,((t,o,i)=>({a:c.getStaticUrl(t.img||"/static/images/default-tech.png"),b:e.t(t.name),c:t.id})))}:{},{l:e.o((e=>c.editProject(t)),t.id),m:e.o((e=>c.deleteProject(t)),t.id),n:t.id,o:e.o((e=>c.editProject(t)),t.id)}))),x:c.getStaticUrl("/static/svg/edit.svg"),y:c.getStaticUrl("/static/svg/delete.svg"),z:0===c.filteredProjects.length},0===c.filteredProjects.length?{A:c.getStaticUrl("/static/svg/project.svg")}:{}),{e:r.error,B:r.showProjectModal},r.showProjectModal?e.e({C:e.t(r.isEdit?"编辑项目":"新增项目"),D:e.o(((...e)=>c.closeProjectModal&&c.closeProjectModal(...e))),E:r.projectForm.title,F:e.o((e=>r.projectForm.title=e.detail.value)),G:r.projectForm.description,H:e.o((e=>r.projectForm.description=e.detail.value)),I:e.t(r.categoryOptions[r.formCategoryIndex+1]),J:e.o(((...e)=>c.onFormCategoryChange&&c.onFormCategoryChange(...e))),K:r.formCategoryIndex,L:r.categoryOptions.slice(1),M:e.t(r.statusOptions[r.formStatusIndex+1]),N:e.o(((...e)=>c.onFormStatusChange&&c.onFormStatusChange(...e))),O:r.formStatusIndex,P:r.statusOptions.slice(1),Q:e.t(r.projectForm.client?r.projectForm.client.name:"请选择关联客户"),R:e.o(((...e)=>t.onFormClientChange&&t.onFormClientChange(...e))),S:r.formClientIndex,T:r.clientOptions,U:e.o(((...e)=>t.openClientSelector&&t.openClientSelector(...e))),V:r.projectForm.tagsInput,W:e.o((e=>r.projectForm.tagsInput=e.detail.value)),X:r.projectForm.technologies&&r.projectForm.technologies.length>0},r.projectForm.technologies&&r.projectForm.technologies.length>0?{Y:e.f(r.projectForm.technologies,((t,o,i)=>({a:c.getStaticUrl(t.img||"/static/images/default-tech.png"),b:e.t(t.name),c:e.o((e=>c.removeTechnology(t)),t.id),d:t.id})))}:{},{Z:c.getStaticUrl("/static/svg/html5.svg"),aa:e.t(r.projectForm.technologies&&r.projectForm.technologies.length>0?"管理技术":"选择技术"),ab:e.o(((...e)=>c.openTechnologySelector&&c.openTechnologySelector(...e))),ac:e.f(r.projectForm.images,((t,o,i)=>({a:c.getStaticUrl(t),b:e.o((e=>c.removeImage(o)),o),c:o}))),ad:r.projectForm.images.length<9},r.projectForm.images.length<9?{ae:e.o(((...e)=>c.chooseImage&&c.chooseImage(...e)))}:{},{af:r.imageError},r.imageError?{ag:e.t(r.imageError)}:{},{ah:e.o(((...e)=>c.closeProjectModal&&c.closeProjectModal(...e))),ai:e.o(((...e)=>c.saveProject&&c.saveProject(...e))),aj:e.o((()=>{})),ak:e.o(((...e)=>c.closeProjectModal&&c.closeProjectModal(...e)))}):{},{al:r.showClientSelector},r.showClientSelector?e.e({am:e.o(((...e)=>t.closeClientSelector&&t.closeClientSelector(...e))),an:r.clientSearchKeyword,ao:e.o((e=>r.clientSearchKeyword=e.detail.value)),ap:e.f(c.filteredClients,((o,i,s)=>e.e({a:e.t(o.name),b:e.t(o.contact||"未设置"),c:e.t(o.phone||"未设置"),d:t.isClientSelected(o)},(t.isClientSelected(o),{}),{e:t.isClientSelected(o)?1:"",f:o.id,g:t.isClientSelected(o)?1:"",h:e.o((e=>t.selectClient(o)),o.id)}))),aq:0===c.filteredClients.length},(c.filteredClients.length,{}),{ar:e.o(((...e)=>t.closeClientSelector&&t.closeClientSelector(...e))),as:e.o(((...e)=>t.confirmClientSelection&&t.confirmClientSelection(...e))),at:e.o((()=>{})),av:e.o(((...e)=>t.closeClientSelector&&t.closeClientSelector(...e)))}):{},{aw:r.showTechnologySelector},r.showTechnologySelector?{ax:e.o(((...e)=>c.closeTechnologySelector&&c.closeTechnologySelector(...e))),ay:r.techSearchKeyword,az:e.o((e=>r.techSearchKeyword=e.detail.value)),aA:e.f(c.filteredTechnologies,((t,o,i)=>e.e({a:c.getStaticUrl(t.img||"/static/images/default-tech.png"),b:e.t(t.name),c:e.t(t.status?"启用":"禁用"),d:e.n(t.status?"active":"inactive"),e:c.isTechnologySelected(t)},(c.isTechnologySelected(t),{}),{f:c.isTechnologySelected(t)?1:"",g:t.id,h:c.isTechnologySelected(t)?1:"",i:e.o((e=>c.toggleTechnology(t)),t.id)}))),aB:e.o(((...e)=>c.closeTechnologySelector&&c.closeTechnologySelector(...e))),aC:e.o(((...e)=>c.confirmTechnologySelection&&c.confirmTechnologySelection(...e))),aD:e.o((()=>{})),aE:e.o(((...e)=>c.closeTechnologySelector&&c.closeTechnologySelector(...e)))}:{})}]]);wx.createPage(s);
