"use strict";const e=require("../../common/vendor.js"),t=require("../../config/config.js"),s=require("../../utils/api.js"),a={data:()=>({searchKeyword:"",showFilter:!1,showUserModal:!1,isEdit:!1,roleIndex:0,statusIndex:0,formStatusIndex:0,statusOptions:["禁用","活跃"],userForm:{id:null,nickname:"",status:"活跃",code_age:8,wechat:null,qq:null,phone:null,email:null,weibo:null,douyin:null,github:null},users:[]}),computed:{filteredUsers(){let e=this.users;if(this.searchKeyword&&(e=e.filter((e=>e.username.toLowerCase().includes(this.searchKeyword.toLowerCase())||e.email.toLowerCase().includes(this.searchKeyword.toLowerCase())))),this.roleIndex>0){const t=this.roleOptions[this.roleIndex];e=e.filter((e=>e.role===t))}if(this.statusIndex>0){const t=1===this.statusIndex?"active":"inactive";e=e.filter((e=>e.status===t))}return e}},methods:{getStaticUrl:e=>t.CONFIG_UTILS.getStaticUrl(e),getStaticUrl:e=>t.CONFIG_UTILS.getStaticUrl(e),goBack(){e.index.navigateBack()},handleSearch(){this.fetchUsers()},onRoleChange(e){this.roleIndex=e.detail.value,this.fetchUsers()},onStatusChange(e){this.statusIndex=e.detail.value,this.fetchUsers()},onFormStatusChange(e){this.formStatusIndex=e.detail.value,this.userForm.status=this.statusOptions[e.detail.value],console.log(this.userForm.status)},async fetchUsers(){try{const e={keyword:this.searchKeyword,role:this.roleIndex>0?this.roleOptions[this.roleIndex]:"",status:this.statusIndex>0?this.statusOptions[this.statusIndex]:""},t=await s.ApiService.user.list(e);this.users=t.list||[]}catch(e){s.ApiErrorHandler.handle(e)}},addUser(){this.isEdit=!1,this.userForm={id:null,email:"",status:this.statusOptions[1]},this.formStatusIndex=1,this.showUserModal=!0},editUser(e){this.isEdit=!0,this.userForm={...e},1===e.status||"active"===e.status||"活跃"===e.status?this.formStatusIndex=1:0===e.status||"inactive"===e.status||"禁用"===e.status?this.formStatusIndex=0:this.formStatusIndex=-1,this.showUserModal=!0},deleteUser(t){e.index.showModal({title:"确认删除",content:`确定要删除用户 "${t.username}" 吗？`,success:async a=>{if(a.confirm)try{await s.ApiService.user.delete(t.id),e.index.showToast({title:"删除成功",icon:"success"}),this.fetchUsers()}catch(o){s.ApiErrorHandler.handle(o)}}})},closeUserModal(){this.showUserModal=!1},async saveUser(){"活跃"===this.userForm.status?this.userForm.status="active":"禁用"===this.userForm.status&&(this.userForm.status="inactive");try{this.isEdit?(await s.ApiService.user.update({id:this.userForm.id,...this.userForm}),e.index.showToast({title:"更新成功",icon:"success"})):(await s.ApiService.user.create(this.userForm),e.index.showToast({title:"添加成功",icon:"success"})),this.closeUserModal(),this.fetchUsers()}catch(t){s.ApiErrorHandler.handle(t)}},async chooseAvatar(){e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:async s=>{if(s.tempFilePaths&&s.tempFilePaths.length>0){const a=s.tempFilePaths[0];e.index.showLoading({title:"上传中..."}),e.index.uploadFile({url:t.CONFIG_UTILS.getApiUrl("/user/uploadAvatar"),filePath:a,name:"avatar",header:{Authorization:"Bearer "+e.index.getStorageSync("wechat_token")},success:t=>{e.index.hideLoading();try{const s=JSON.parse(t.data);200===s.code&&s.data&&s.data.url?(this.userForm.avatar=s.data.url,e.index.showToast({title:"上传成功",icon:"success"})):e.index.showToast({title:s.message||"上传失败",icon:"none"})}catch(s){e.index.showToast({title:"上传失败",icon:"none"})}},fail:()=>{e.index.hideLoading(),e.index.showToast({title:"上传失败",icon:"none"})}})}}})}},onLoad(){const t=e.index.getStorageSync("wechat_token"),s=e.index.getStorageSync("userInfo");return t&&s?"admin"!==s.user_type?(e.index.showToast({title:"无管理员权限",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3)):void 0:(e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3))},mounted(){this.fetchUsers()}};const o=e._export_sfc(a,[["render",function(t,s,a,o,i,r){return e.e({a:r.getStaticUrl("/static/svg/left.svg"),b:e.o(((...e)=>r.goBack&&r.goBack(...e))),c:e.o(((...e)=>r.addUser&&r.addUser(...e))),d:r.getStaticUrl("/static/svg/search.svg"),e:e.o([e=>i.searchKeyword=e.detail.value,(...e)=>r.handleSearch&&r.handleSearch(...e)]),f:i.searchKeyword,g:r.getStaticUrl("/static/svg/filter.svg"),h:e.o((e=>i.showFilter=!i.showFilter)),i:i.showFilter},i.showFilter?{j:e.t(t.roleOptions[i.roleIndex]),k:e.o(((...e)=>r.onRoleChange&&r.onRoleChange(...e))),l:i.roleIndex,m:t.roleOptions,n:e.t(i.statusOptions[i.statusIndex]),o:e.o(((...e)=>r.onStatusChange&&r.onStatusChange(...e))),p:i.statusIndex,q:i.statusOptions}:{},{r:e.f(r.filteredUsers,((t,s,a)=>({a:r.getStaticUrl(t.avatar||"/static/images/default-avatar.jpg"),b:e.n(1===t.status?"status-active":"status-inactive"),c:e.t(t.username),d:e.t(t.email),e:e.t(t.role),f:e.o((e=>r.editUser(t)),t.id),g:e.o((e=>r.deleteUser(t)),t.id),h:t.id,i:e.o((e=>r.editUser(t)),t.id)}))),s:r.getStaticUrl("/static/svg/edit.svg"),t:r.getStaticUrl("/static/svg/delete.svg"),v:0===r.filteredUsers.length},0===r.filteredUsers.length?{w:r.getStaticUrl("/static/svg/user.svg")}:{},{x:i.showUserModal},i.showUserModal?{y:e.t(i.isEdit?"编辑用户":"新增用户"),z:e.o(((...e)=>r.closeUserModal&&r.closeUserModal(...e))),A:r.getStaticUrl(i.userForm.avatar||"/static/images/default-avatar.jpg"),B:e.o(((...e)=>r.chooseAvatar&&r.chooseAvatar(...e))),C:i.userForm.nickname,D:e.o((e=>i.userForm.nickname=e.detail.value)),E:i.userForm.code_age,F:e.o((e=>i.userForm.code_age=e.detail.value)),G:i.userForm.wechat,H:e.o((e=>i.userForm.wechat=e.detail.value)),I:i.userForm.qq,J:e.o((e=>i.userForm.qq=e.detail.value)),K:i.userForm.phone,L:e.o((e=>i.userForm.phone=e.detail.value)),M:i.userForm.email,N:e.o((e=>i.userForm.email=e.detail.value)),O:i.userForm.weibo,P:e.o((e=>i.userForm.weibo=e.detail.value)),Q:i.userForm.github,R:e.o((e=>i.userForm.github=e.detail.value)),S:i.userForm.douyin,T:e.o((e=>i.userForm.douyin=e.detail.value)),U:i.userForm.code_age,V:e.o((e=>i.userForm.code_age=e.detail.value)),W:e.t(-1===i.formStatusIndex?"请选择":i.statusOptions[i.formStatusIndex]),X:e.o(((...e)=>r.onFormStatusChange&&r.onFormStatusChange(...e))),Y:i.formStatusIndex,Z:i.statusOptions,aa:e.o(((...e)=>r.closeUserModal&&r.closeUserModal(...e))),ab:e.o(((...e)=>r.saveUser&&r.saveUser(...e))),ac:e.o((()=>{})),ad:e.o(((...e)=>r.closeUserModal&&r.closeUserModal(...e)))}:{})}]]);wx.createPage(o);
