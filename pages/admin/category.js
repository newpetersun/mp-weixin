"use strict";const e=require("../../common/vendor.js"),t=require("../../config/config.js"),o=require("../../utils/api.js"),r={data:()=>({searchKeyword:"",showCategoryModal:!1,isEdit:!1,loading:!1,error:null,statusIndex:0,statusOptions:["启用","禁用"],categoryForm:{id:null,name:"",key:"",description:"",sort_order:0,status:1},errors:{},categories:[]}),computed:{filteredCategories(){if(!this.searchKeyword)return this.categories;const e=this.searchKeyword.toLowerCase();return this.categories.filter((t=>t.name.toLowerCase().includes(e)||t.key.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e)))}},methods:{getStaticUrl:e=>t.CONFIG_UTILS.getStaticUrl(e),goBack(){e.index.navigateBack()},handleSearch(){},onStatusChange(e){this.statusIndex=e.detail.value,this.categoryForm.status=0===this.statusIndex?1:0},async toggleStatus(t){try{const r=t.status?0:1;await o.ApiService.category.updateStatus(t.id,r),t.status=r,e.index.showToast({title:"状态更新成功",icon:"success"})}catch(r){o.ApiErrorHandler.handle(r)}},addCategory(){this.isEdit=!1,this.categoryForm={id:null,name:"",key:"",description:"",sort_order:0,status:1},this.statusIndex=0,this.errors={},this.showCategoryModal=!0},editCategory(e){this.isEdit=!0,this.categoryForm={...e},this.statusIndex=e.status?0:1,this.errors={},this.showCategoryModal=!0},deleteCategory(t){e.index.showModal({title:"确认删除",content:`确定要删除分类 "${t.name}" 吗？`,success:async r=>{if(r.confirm)try{await o.ApiService.category.delete(t.id),this.categories=this.categories.filter((e=>e.id!==t.id)),e.index.showToast({title:"删除成功",icon:"success"})}catch(a){o.ApiErrorHandler.handle(a)}}})},closeCategoryModal(){this.showCategoryModal=!1},async saveCategory(){this.errors={};let t=!1;if(this.categoryForm.name||(this.errors.name="请输入分类名称",t=!0),this.categoryForm.key?/^[a-z0-9_-]+$/.test(this.categoryForm.key)||(this.errors.key="分类标识只能包含小写字母、数字、下划线和连字符",t=!0):(this.errors.key="请输入分类标识",t=!0),!t)try{if(this.isEdit){await o.ApiService.category.update(this.categoryForm.id,this.categoryForm);const t=this.categories.findIndex((e=>e.id===this.categoryForm.id));-1!==t&&this.categories.splice(t,1,{...this.categoryForm}),e.index.showToast({title:"更新成功",icon:"success"})}else{const t=await o.ApiService.category.create(this.categoryForm);this.categories.unshift({...this.categoryForm,id:t.id}),e.index.showToast({title:"添加成功",icon:"success"})}this.closeCategoryModal()}catch(r){o.ApiErrorHandler.handle(r)}},async loadCategoryData(){this.loading=!0,this.error=null;try{const e=await o.ApiService.category.getList();this.categories=e.list||[]}catch(e){this.error=e.message||"数据加载失败",o.ApiErrorHandler.handle(e)}finally{this.loading=!1}}},onLoad(){const t=e.index.getStorageSync("wechat_token"),o=e.index.getStorageSync("userInfo");return t&&o?"admin"!==o.user_type?(e.index.showToast({title:"无管理员权限",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3)):void this.loadCategoryData():(e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3))},onShow(){this.loadCategoryData()}};const a=e._export_sfc(r,[["render",function(t,o,r,a,s,i){return e.e({a:i.getStaticUrl("/static/svg/left.svg"),b:e.o(((...e)=>i.goBack&&i.goBack(...e))),c:e.o(((...e)=>i.addCategory&&i.addCategory(...e))),d:s.loading},s.loading?{}:s.error?{f:e.t(s.error),g:e.o(((...e)=>i.loadCategoryData&&i.loadCategoryData(...e)))}:e.e({h:i.getStaticUrl("/static/svg/search.svg"),i:e.o([e=>s.searchKeyword=e.detail.value,(...e)=>i.handleSearch&&i.handleSearch(...e)]),j:s.searchKeyword,k:e.f(i.filteredCategories,((t,o,r)=>({a:e.t(t.id),b:e.t(t.name),c:e.t(t.key),d:e.t(t.sort_order),e:e.t(t.status?"启用":"禁用"),f:e.n(t.status?"status-active":"status-inactive"),g:e.o((e=>i.toggleStatus(t)),t.id),h:e.o((e=>i.editCategory(t)),t.id),i:e.o((e=>i.deleteCategory(t)),t.id),j:t.id}))),l:i.getStaticUrl("/static/svg/edit.svg"),m:i.getStaticUrl("/static/svg/delete.svg"),n:0===i.filteredCategories.length},0===i.filteredCategories.length?{o:i.getStaticUrl("/static/svg/category.svg")}:{}),{e:s.error,p:s.showCategoryModal},s.showCategoryModal?e.e({q:e.t(s.isEdit?"编辑分类":"新增分类"),r:e.o(((...e)=>i.closeCategoryModal&&i.closeCategoryModal(...e))),s:s.categoryForm.name,t:e.o((e=>s.categoryForm.name=e.detail.value)),v:s.errors.name},s.errors.name?{w:e.t(s.errors.name)}:{},{x:s.categoryForm.key,y:e.o((e=>s.categoryForm.key=e.detail.value)),z:s.errors.key},s.errors.key?{A:e.t(s.errors.key)}:{},{B:s.categoryForm.description,C:e.o((e=>s.categoryForm.description=e.detail.value)),D:s.categoryForm.sort_order,E:e.o((e=>s.categoryForm.sort_order=e.detail.value)),F:e.t(s.statusOptions[s.statusIndex]),G:e.o(((...e)=>i.onStatusChange&&i.onStatusChange(...e))),H:s.statusIndex,I:s.statusOptions,J:e.o(((...e)=>i.closeCategoryModal&&i.closeCategoryModal(...e))),K:e.o(((...e)=>i.saveCategory&&i.saveCategory(...e))),L:e.o((()=>{})),M:e.o(((...e)=>i.closeCategoryModal&&i.closeCategoryModal(...e)))}):{})}]]);wx.createPage(a);
