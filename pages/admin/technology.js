"use strict";const e=require("../../common/vendor.js"),o=require("../../config/config.js"),t=require("../../utils/api.js"),i={data:()=>({loading:!1,error:null,searchKeyword:"",technologies:[],showTechnologyModal:!1,showDeleteModal:!1,isEdit:!1,saving:!1,deleting:!1,deleteItem:null,technologyForm:{name:"",img:"",sort_order:0,status:!0},errors:{}}),computed:{filteredTechnologies(){return this.searchKeyword?this.technologies.filter((e=>e.name.toLowerCase().includes(this.searchKeyword.toLowerCase())||e.category&&e.category.toLowerCase().includes(this.searchKeyword.toLowerCase()))):this.technologies}},methods:{getStaticUrl:e=>o.CONFIG_UTILS.getStaticUrl(e),goBack(){e.index.navigateBack()},async loadTechnologyData(){this.loading=!0,this.error=null;try{const e=await t.ApiService.technology.getList();this.technologies=e.list}catch(e){this.error=e.message||"数据加载失败",t.ApiErrorHandler.handle(e)}finally{this.loading=!1}},handleSearch(){},addTechnology(){this.isEdit=!1,this.technologyForm={name:"",category:"",img:"",sort_order:0,status:!0},this.errors={},this.showTechnologyModal=!0},editTechnology(e){this.isEdit=!0,this.technologyForm={id:e.id,name:e.name,category:e.category||"",img:e.img||"",sort_order:e.sort_order||0,status:!1!==e.status},this.errors={},this.showTechnologyModal=!0},deleteTechnology(e){this.deleteItem=e,this.showDeleteModal=!0},async toggleStatus(o){try{const i=!o.status;await t.ApiService.technology.updateStatus(o.id,i),o.status=i,e.index.showToast({title:i?"已启用":"已禁用",icon:"success",duration:2e3})}catch(i){t.ApiErrorHandler.handle(i)}},onStatusChange(e){this.technologyForm.status=e.detail.value},async saveTechnology(){if(this.errors={},this.technologyForm.name.trim()){this.saving=!0;try{if(this.isEdit){await t.ApiService.technology.update(this.technologyForm.id,this.technologyForm);const e=this.technologies.findIndex((e=>e.id===this.technologyForm.id));-1!==e&&(this.technologies[e]={...this.technologies[e],...this.technologyForm})}else{const e=await t.ApiService.technology.create(this.technologyForm);this.technologies.unshift(e)}this.closeTechnologyModal(),e.index.showToast({title:this.isEdit?"更新成功":"添加成功",icon:"success",duration:2e3})}catch(o){t.ApiErrorHandler.handle(o)}finally{this.saving=!1}}else this.errors.name="请输入技术名称"},closeTechnologyModal(){this.showTechnologyModal=!1,this.technologyForm={name:"",category:"",img:"",sort_order:0,status:!0},this.errors={}},cancelDelete(){this.showDeleteModal=!1,this.deleteItem=null},async confirmDelete(){if(this.deleteItem){this.deleting=!0;try{await t.ApiService.technology.delete(this.deleteItem.id);const o=this.technologies.findIndex((e=>e.id===this.deleteItem.id));200===o&&this.technologies.splice(o,1),this.cancelDelete(),this.closeTechnologyModal(),e.index.showToast({title:"删除成功",icon:"success",duration:2e3})}catch(o){t.ApiErrorHandler.handle(o)}finally{this.deleting=!1}}},chooseImage(){e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:e=>{const o=e.tempFilePaths[0];this.uploadImage(o)},fail:o=>{console.error("选择图片失败:",o),e.index.showToast({title:"选择图片失败",icon:"none",duration:2e3})}})},async uploadImage(o){e.index.showLoading({title:"上传中..."});try{const i=await t.ApiService.technology.uploadImage(o);this.technologyForm.img=i.url,e.index.hideLoading(),e.index.showToast({title:"上传成功",icon:"success",duration:2e3})}catch(i){e.index.hideLoading(),console.error("上传失败:",i),e.index.showToast({title:i.message||"上传失败",icon:"none",duration:2e3})}},removeImage(){this.technologyForm.img=""}},onLoad(){const o=e.index.getStorageSync("wechat_token"),t=e.index.getStorageSync("userInfo");return o&&t?"admin"!==t.user_type?(e.index.showToast({title:"无管理员权限",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3)):void this.loadTechnologyData():(e.index.showToast({title:"请先登录",icon:"none",duration:2e3}),void setTimeout((()=>{e.index.redirectTo({url:"/pages/index/index"})}),2e3))}};const s=e._export_sfc(i,[["render",function(o,t,i,s,a,l){var n;return e.e({a:l.getStaticUrl("/static/svg/left.svg"),b:e.o(((...e)=>l.goBack&&l.goBack(...e))),c:a.loading},a.loading?{}:a.error?{e:e.t(a.error),f:e.o(((...e)=>l.loadTechnologyData&&l.loadTechnologyData(...e)))}:e.e({g:l.getStaticUrl("/static/svg/search.svg"),h:e.o([e=>a.searchKeyword=e.detail.value,(...e)=>l.handleSearch&&l.handleSearch(...e)]),i:a.searchKeyword,j:l.getStaticUrl("/static/svg/upload.svg"),k:e.o(((...e)=>l.addTechnology&&l.addTechnology(...e))),l:e.f(l.filteredTechnologies,((o,t,i)=>({a:l.getStaticUrl(o.img||"/static/images/default-tech.png"),b:o.id,c:e.o((e=>l.editTechnology(o)),o.id)}))),m:0===a.technologies.length&&!a.loading},0!==a.technologies.length||a.loading?{}:{n:l.getStaticUrl("/static/svg/html5.svg"),o:e.o(((...e)=>l.addTechnology&&l.addTechnology(...e)))}),{d:a.error,p:a.showTechnologyModal},a.showTechnologyModal?e.e({q:e.t(a.isEdit?"编辑技术":"新增技术"),r:e.o(((...e)=>l.closeTechnologyModal&&l.closeTechnologyModal(...e))),s:a.technologyForm.name,t:e.o((e=>a.technologyForm.name=e.detail.value)),v:a.errors.name},a.errors.name?{w:e.t(a.errors.name)}:{},{x:a.technologyForm.img},a.technologyForm.img?{y:l.getStaticUrl(a.technologyForm.img||"/static/images/default-tech.png"),z:e.o(((...e)=>l.chooseImage&&l.chooseImage(...e))),A:e.o(((...e)=>l.removeImage&&l.removeImage(...e)))}:{B:l.getStaticUrl("/static/svg/upload.svg"),C:e.o(((...e)=>l.chooseImage&&l.chooseImage(...e)))},{D:a.technologyForm.sort_order,E:e.o((e=>a.technologyForm.sort_order=e.detail.value)),F:a.technologyForm.status,G:e.o(((...e)=>l.onStatusChange&&l.onStatusChange(...e))),H:e.t(a.technologyForm.status?"启用":"禁用"),I:a.isEdit},a.isEdit?{J:e.o((e=>l.deleteTechnology(a.technologyForm)))}:{},{K:e.o(((...e)=>l.closeTechnologyModal&&l.closeTechnologyModal(...e))),L:e.t(a.saving?"保存中...":"保存"),M:e.o(((...e)=>l.saveTechnology&&l.saveTechnology(...e))),N:a.saving,O:a.isEdit?1:"",P:e.o((()=>{})),Q:e.o(((...e)=>l.closeTechnologyModal&&l.closeTechnologyModal(...e)))}):{},{R:a.showDeleteModal},a.showDeleteModal?{S:e.o(((...e)=>l.cancelDelete&&l.cancelDelete(...e))),T:e.t(null==(n=a.deleteItem)?void 0:n.name),U:e.o(((...e)=>l.cancelDelete&&l.cancelDelete(...e))),V:e.t(a.deleting?"删除中...":"确认删除"),W:e.o(((...e)=>l.confirmDelete&&l.confirmDelete(...e))),X:a.deleting,Y:e.o((()=>{})),Z:e.o(((...e)=>l.cancelDelete&&l.cancelDelete(...e)))}:{})}]]);wx.createPage(s);
